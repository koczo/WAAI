@page "/changelog"
@inject HttpClient Http

<PageTitle>Changelog</PageTitle>

<div class="max-w-4xl mx-auto p-6">
    <h1 class="text-4xl font-bold mb-8">Changelog</h1>

    @if (_commits == null)
    {
        <div class="flex justify-center">
            <span class="loading loading-infinity loading-lg text-primary"></span>
        </div>
    }
    else if (!_commits.Any())
    {
        <div class="alert alert-info">
            <span>No commits found.</span>
        </div>
    }
    else
    {
        <div class="space-y-6">
            @foreach (var group in _commits.GroupBy(c => c.Date.ToString("yyyy-MM-dd")))
            {
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title text-2xl">@group.Key</h2>
                        <div class="space-y-4">
                            @foreach (var commit in group)
                            {
                                var (type, description) = ParseCommit(commit.Message);
                                <div class="flex gap-3">
                                    <div class="badge @GetBadgeClass(type) badge-lg">@type</div>
                                    <div class="flex-1">
                                        <p class="font-medium">@description</p>
                                        <div class="flex gap-2 items-center mt-1">
                                            @if (!string.IsNullOrEmpty(commit.Version))
                                            {
                                                <span class="badge badge-sm badge-outline">@commit.Version</span>
                                                <span class="text-xs opacity-60">•</span>
                                            }
                                            <span class="text-xs opacity-60">@commit.Sha.Substring(0, 7)</span>
                                            <span class="text-xs opacity-60">•</span>
                                            <span class="text-xs opacity-60">@commit.Date.ToString("HH:mm")</span>
                                            <a href="@commit.Url" target="_blank" class="link link-primary text-xs">View</a>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<CommitInfo>? _commits;
    private List<TagInfo>? _tags;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _commits = await Http.GetFromJsonAsync<List<CommitInfo>>("https://api.github.com/repos/koczo/WAAI/commits");
            _tags = await Http.GetFromJsonAsync<List<TagInfo>>("https://api.github.com/repos/koczo/WAAI/tags");
            
            if (_commits != null && _tags != null)
            {
                foreach (var commit in _commits)
                {
                    var tag = _tags.FirstOrDefault(t => t.Commit.Sha == commit.Sha);
                    if (tag != null)
                    {
                        commit.Version = tag.Name;
                    }
                }
            }
        }
        catch
        {
            _commits = new List<CommitInfo>();
        }
    }

    private (string type, string description) ParseCommit(string message)
    {
        var firstLine = message.Split('\n')[0].Replace("\"", string.Empty);
        var colonIndex = firstLine.IndexOf(':');

        if (colonIndex is <= 0 or >= 20) return ("update", firstLine);
        
        var type = firstLine.Substring(0, colonIndex).Trim();
        var desc = firstLine.Substring(colonIndex + 1).Trim();
        return (type, desc);

    }

    private string GetBadgeClass(string type) => type.ToLower() switch
    {
        "feat" => "badge-success",
        "fix" => "badge-error",
        "docs" => "badge-info",
        "style" => "badge-secondary",
        "refactor" => "badge-warning",
        "test" => "badge-accent",
        "chore" => "badge-neutral",
        _ => "badge-ghost badge-dash"
    };

    private class CommitInfo
    {
        public string Sha { get; set; } = string.Empty;
        public CommitDetails Commit { get; set; } = new();
        public string Html_Url { get; set; } = string.Empty;
        public string Url => Html_Url;
        public DateTime Date => Commit.Author.Date;
        public string Message => Commit.Message;
        public string Version { get; set; } = string.Empty;
    }

    private class CommitDetails
    {
        public string Message { get; set; } = string.Empty;
        public AuthorInfo Author { get; set; } = new();
    }

    private class AuthorInfo
    {
        public DateTime Date { get; set; }
    }

    private class TagInfo
    {
        public string Name { get; set; } = string.Empty;
        public TagCommit Commit { get; set; } = new();
    }

    private class TagCommit
    {
        public string Sha { get; set; } = string.Empty;
    }
}
