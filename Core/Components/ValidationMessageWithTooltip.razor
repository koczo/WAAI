@using System.Linq.Expressions
@typeparam TValue

@if (_errors.Any())
{
    <div class="text-error text-sm mt-1">
        @_errors.First()
        @if (_errors.Count > 1)
        {
            <span class="relative inline-block ml-1 group">
                <span class="cursor-help text-error font-semibold">+@(_errors.Count - 1)</span>
                <div class="absolute bottom-full left-0 mb-2 hidden group-hover:block bg-base-300 text-base-content text-xs rounded py-2 px-3 whitespace-nowrap z-10">
                    @foreach (var error in _errors.Skip(1))
                    {
                        <div>â€¢ @error</div>
                    }
                </div>
            </span>
        }
    </div>
}

@code {
    [Parameter] public Expression<Func<TValue>>? For { get; set; }
    [CascadingParameter] public EditContext? EditContext { get; set; }

    private List<string> _errors = new();
    private FieldIdentifier _fieldIdentifier;

    protected override void OnInitialized()
    {
        if (EditContext == null || For == null)
            return;

        _fieldIdentifier = FieldIdentifier.Create(For);
        EditContext.OnValidationStateChanged += HandleValidationStateChanged;
        UpdateErrors();
    }

    private void HandleValidationStateChanged(object? sender, ValidationStateChangedEventArgs e)
    {
        UpdateErrors();
        StateHasChanged();
    }

    private void UpdateErrors()
    {
        if (EditContext == null)
            return;

        _errors = EditContext.GetValidationMessages(_fieldIdentifier).ToList();
    }

    public void Dispose()
    {
        if (EditContext != null)
            EditContext.OnValidationStateChanged -= HandleValidationStateChanged;
    }

}
