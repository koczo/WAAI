@using Ardalis.SmartEnum
@using WAAI.Core.Models
@typeparam TStep where TStep : SmartEnum<TStep>
@using Blazilla

<Card>
    @if (ShowProgressStepper)
    {
        <ProgressStepper TStep="TStep" CurrentStep="CurrentStep" />
    }

    <EditForm EditContext="_editContext" OnValidSubmit="NextStep">
        <FluentValidator />
        @StepContent
    </EditForm>

    <div class="flex @(IsFirstStep() ? "justify-end" : "justify-between") mt-8 pt-6 border-t border-gray-200">
        <Button OnClick="PreviousStep" 
                Visible="@(!IsFirstStep())"
                Variant="Button.ButtonVariant.Secondary">
            ← Previous
        </Button>
        
        @if (!IsLastStep())
        {
            <Button OnClick="HandleNext" Variant="Button.ButtonVariant.Primary">
                Next →
            </Button>
        }
        else
        {
            <Button OnClick="OnComplete" Variant="Button.ButtonVariant.Success">
                @CompleteButtonText
            </Button>
        }
    </div>
</Card>

@code {
    [Parameter] public TStep CurrentStep { get; set; } = default!;
    [Parameter] public EventCallback<TStep> CurrentStepChanged { get; set; }
    [Parameter] public RenderFragment? StepContent { get; set; }
    [Parameter] public Dictionary<TStep, IStepModel> Models { get; set; } = null!;
    [Parameter] public EventCallback OnComplete { get; set; }
    [Parameter] public string CompleteButtonText { get; set; } = "Finish ✓";
    [Parameter] public bool ShowProgressStepper { get; set; } = true;

    private EditContext _editContext = null!;
    private List<TStep> _steps = null!;

    protected override void OnInitialized()
    {
        _steps = SmartEnum<TStep>.List.OrderBy(x => x).ToList();
        _editContext = new EditContext(GetModelForStep(CurrentStep));
    }

    protected override void OnParametersSet()
    {
        _editContext = new EditContext(GetModelForStep(CurrentStep));
    }

    private IStepModel GetModelForStep(TStep step) =>
        Models.TryGetValue(step, out var model) ? model : throw new InvalidOperationException("Step does not exist");

    private async Task HandleNext()
    {
        if (_editContext.Validate())
        {
            await NextStep();
        }
    }

    private async Task NextStep()
    {
        var currentIndex = _steps.IndexOf(CurrentStep);
        if (currentIndex < _steps.Count - 1)
        {
            CurrentStep = _steps[currentIndex + 1];
            await CurrentStepChanged.InvokeAsync(CurrentStep);
            _editContext = new EditContext(GetModelForStep(CurrentStep));
        }
    }

    private async Task PreviousStep()
    {
        var currentIndex = _steps.IndexOf(CurrentStep);
        if (currentIndex > 0)
        {
            CurrentStep = _steps[currentIndex - 1];
            await CurrentStepChanged.InvokeAsync(CurrentStep);
            _editContext = new EditContext(GetModelForStep(CurrentStep));
        }
    }

    private bool IsFirstStep() => _steps.IndexOf(CurrentStep) == 0;

    private bool IsLastStep() => _steps.IndexOf(CurrentStep) == _steps.Count - 1;
}
